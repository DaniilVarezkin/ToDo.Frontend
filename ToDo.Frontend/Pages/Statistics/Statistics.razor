@page "/statistics"
@attribute [Authorize]
@using ToDo.Frontend.Services.Statistic
@using ToDo.Shared.Dto.Statistics
@using MudBlazor
@inject IStatisticService StatisticService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4 mb-4 mud-elevation-2">
    <MudGrid GutterSize="4">
        <MudItem xs="12" sm="4">
            <MudCard Class="pa-4 d-flex flex-column align-center">
                <MudText Typo="Typo.h6">Всего задач</MudText>
                <MudText Typo="Typo.h3">@_global.TotalCount</MudText>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudCard Class="pa-4 d-flex flex-column align-center">
                <MudText Typo="Typo.h6">Среднее время (ч)</MudText>
                <MudText Typo="Typo.h3">@_global.AvgCompletionTimeHours.ToString("F1")</MudText>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudCard Class="pa-4 d-flex flex-column align-center">
                <MudText Typo="Typo.h6">Просрочено всего</MudText>
                <MudText Typo="Typo.h3">@_global.OverdueCount</MudText>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper Class="pa-4 mb-4 mud-elevation-2 d-flex justify-center">
    <MudChart ChartType="ChartType.Donut"
              Width="300px"
              Height="300px"
              InputData="@_statusData"
              InputLabels="@_statusLabels">
        <CustomGraphics>
            <text x="50%" y="42%" dominant-baseline="middle" text-anchor="middle" font-size="18">По статусам</text>
            <text x="50%" y="58%" dominant-baseline="middle" text-anchor="middle" font-size="28">@_statusData.Sum()</text>
        </CustomGraphics>
    </MudChart>
</MudPaper>

<MudPaper Class="pa-4 mb-4 mud-elevation-2">
    <MudChart ChartType="ChartType.StackedBar"
              ChartSeries="@_dailyBarSeries"
              XAxisLabels="@_dailyLabels"
              Width="100%"
              Height="350px" />
</MudPaper>

<MudPaper Class="pa-4 mb-4 mud-elevation-2">
    <MudChart ChartType="ChartType.StackedBar"
              ChartSeries="@_statusSeries"
              XAxisLabels="@_statusLabels"
              Width="100%"
              Height="400px" />
</MudPaper>

<MudPaper Class="pa-4 mud-elevation-2">
    <MudTimeSeriesChart ChartSeries="@_trendSeries"
                        Width="100%"
                        Height="400px"
                        TimeLabelSpacing="TimeSpan.FromDays(1)"
                        CanHideSeries="true"
                        DataMarkerTooltipTimeLabelFormat="yyyy-MM-dd" />
</MudPaper>

@code {
    private GlobalTaskStatisticsVm _global = new();
    private double[] _statusData = Array.Empty<double>();
    private string[] _statusLabels = Array.Empty<string>();
    private List<ChartSeries> _statusSeries = new();

    // Для дневных баров: Создано/Завершено/Просрочено
    private List<ChartSeries> _dailyBarSeries = new();
    private string[] _dailyLabels = Array.Empty<string>();

    private List<TimeSeriesChartSeries> _trendSeries = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1) Глобальная статистика
            _global = await StatisticService.GetGlobalAsync();
            BuildStatusCharts();

            // 2) История метрик за 14 дней
            var historyVm = await StatisticService.GetStatusHistoryAsync(days: 14);
            BuildDailyBars(historyVm);
            BuildTrends(historyVm);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка при загрузке статистики: {ex.Message}", Severity.Error);
        }
    }

    private void BuildStatusCharts()
    {
        _statusLabels = _global.ByStatus.Keys.Select(k => k.ToString()).ToArray();
        _statusData = _global.ByStatus.Values.Select(v => (double)v).ToArray();
        _statusSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Количество", Data = _statusData }
        };
    }

    private void BuildDailyBars(TaskStatusHistoryVm vm)
    {
        // Метки x-axis
        _dailyLabels = vm.CreatedHistory
            .OrderBy(x => x.Day)
            .Select(x => x.Day.ToString("MM-dd"))
            .ToArray();

        // Данные
        var created = vm.CreatedHistory.OrderBy(x => x.Day).Select(x => (double)x.Count).ToArray();
        var completed = vm.CompletedHistory.OrderBy(x => x.Day).Select(x => (double)x.Count).ToArray();
        var overdue = vm.OverdueHistory.OrderBy(x => x.Day).Select(x => (double)x.Count).ToArray();

        _dailyBarSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Создано", Data = created },
            new ChartSeries { Name = "Завершено", Data = completed },
            new ChartSeries { Name = "Просрочено", Data = overdue }
        };
    }

    private void BuildTrends(TaskStatusHistoryVm vm)
    {
        var created = vm.CreatedHistory.OrderBy(x => x.Day)
            .Select(x => new TimeSeriesChartSeries.TimeValue(x.Day.DateTime, x.Count)).ToList();
        var completed = vm.CompletedHistory.OrderBy(x => x.Day)
            .Select(x => new TimeSeriesChartSeries.TimeValue(x.Day.DateTime, x.Count)).ToList();
        var overdue = vm.OverdueHistory.OrderBy(x => x.Day)
            .Select(x => new TimeSeriesChartSeries.TimeValue(x.Day.DateTime, x.Count)).ToList();

        _trendSeries = new List<TimeSeriesChartSeries>
        {
            new TimeSeriesChartSeries { Name = "Создано", Data = created, IsVisible = true, LineDisplayType = LineDisplayType.Line },
            new TimeSeriesChartSeries { Name = "Завершено", Data = completed, IsVisible = true, LineDisplayType = LineDisplayType.Line },
            new TimeSeriesChartSeries { Name = "Просрочено", Data = overdue, IsVisible = true, LineDisplayType = LineDisplayType.Line }
        };
    }
}
